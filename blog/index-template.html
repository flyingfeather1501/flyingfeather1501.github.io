@; vim: filetype=scribble
@; { Template for each item in an index }
@(local-require (only-in xml string->xexpr)
                txexpr threading racket/format racket/string)

@(struct tag-st (name url) #:transparent)

@(define (not-special? tag)
   ;; or here for adding more rules later
   (not (or (string-prefix? (tag-st-name tag) "language:"))))

@(define (taglist->comma-html taglist)
   ; listof tag-st -> string
   (~> (map (λ (x) (xexpr->html `(a ([href ,(tag-st-url x)]) ,(tag-st-name x))))
            taglist)
       (add-between _ ", ")
       (string-join _ "")))

@(define filtered-tags
   (~> (string-replace tags ", " "")
       string->xexpr
       get-elements ; strip away the top level span
       (filter txexpr? _) ; strip away the leftover newlines between each element
       (map (λ (x) (tag-st (last x) (attr-ref x 'href))) _)
       (filter not-special? _)
       taglist->comma-html
   ))

<article>
  <header class='index-item'>
    <p class='date-and-tags'>@|date| :: @|filtered-tags|</p>
    <p><a href='@|uri-path|'>@|title|</a></p>
  </header>
  @;{@|content-only|
  @(when more?
    @list{<footer>
            <a href='@|uri-path|'>&hellip; more &hellip;</a>
        </footer>})}
</article>
<br>
